{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %} SISIMPUR - AI-Powered Exam Prep {% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/quiz_create.css' %}">
{% endblock %}

{% block content %}
    <!-- Page Content -->
    <div class="content-wrapper">
      <div class="content-container">
        <div class="quiz-section" data-process-url="{% url 'dashboard:api_process_document' %}">
          <h1 class="page-title">Create Quiz</h1>
          <p class="page-description">Generate AI-powered quizzes from your content</p>

          <div class="quiz-form">
            <!-- Quiz Options Form -->
            <div class="quiz-options-form">
              <h3>Quiz Configuration</h3>

              <div class="quiz-options">
                <div class="option-group">
                  <label for="question-count">Number of Questions</label>
                  <select class="quiz-select" id="question-count" name="num_questions">
                    <option value="">Auto (Optimal)</option>
                    <option value="3">3 Questions</option>
                    <option value="5">5 Questions</option>
                    <option value="8">8 Questions</option>
                    <option value="10" selected>10 Questions</option>
                    <option value="15">15 Questions</option>
                    <option value="20">20 Questions</option>
                  </select>
                </div>

                <div class="option-group">
                  <label for="question-type">Question Type</label>
                  <select class="quiz-select" id="question-type" name="question_type">
                    <option value="MULTIPLECHOICE" selected>Multiple Choice</option>
                    <option value="SHORT">Short Answer</option>
                  </select>
                </div>

                <div class="option-group">
                  <label for="language">Language Detection</label>
                  <select class="quiz-select" id="language" name="language">
                    <option value="auto" selected>Auto Detect</option>
                    <option value="english">English</option>
                    <option value="bengali">Bengali</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Dropzone File Upload -->
            <div class="upload-section">
              <h3>Upload Document</h3>
              <p class="upload-description">Upload a document first, then click Generate to process it</p>

              <!-- CSRF token for Dropzone AJAX -->
              <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

              <div class="dropzone" id="document-dropzone">
                <div class="dz-message" data-dz-message>
                  <div class="upload-icon">
                    <i class="ri-upload-cloud-line"></i>
                  </div>
                  <h4>Drop files here or click to upload</h4>
                  <p>Supported: PDF, JPG, PNG (Max 10MB)</p>
                </div>
              </div>

              <!-- Camera Upload Button (Mobile Only) -->
              <button type="button" class="camera-upload-btn" id="camera-upload-btn">
                <i class="ri-camera-line"></i> Upload using Camera
              </button>
              <input type="file" accept="image/*" capture="environment" id="camera-file-input" style="display:none;" />

              <!-- Generate Button -->
              <button type="button" class="generate-btn" id="generate-btn" disabled>
                <i class="ri-magic-line"></i>
                <span id="btn-text">Generate Quiz</span>
                <div id="loading-spinner" style="display: none;">
                  <i class="ri-loader-4-line"></i> Processing...
                </div>
              </button>
            </div>

            <!-- Modern Processing Status -->
            <div id="processing-status" style="display: none;" class="modern-processing-status">
              <div class="processing-container">
                <!-- Animated Background -->
                <div class="processing-bg">
                  <div class="processing-particles"></div>
                  <div class="processing-waves">
                    <div class="wave wave-1"></div>
                    <div class="wave wave-2"></div>
                    <div class="wave wave-3"></div>
                  </div>
                </div>

                <!-- Main Content -->
                <div class="processing-content">
                  <!-- Progress Ring -->
                  <div class="progress-ring-container">
                    <svg class="progress-ring" width="120" height="120">
                      <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                          <stop offset="0%" style="stop-color:#5e17eb;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                        </linearGradient>
                      </defs>
                      <circle class="progress-ring-bg" cx="60" cy="60" r="50" />
                      <circle class="progress-ring-fill" cx="60" cy="60" r="50" id="progress-circle" />
                    </svg>
                    <div class="progress-center">
                      <div class="progress-icon" id="progress-icon">
                        <i class="ri-file-text-line"></i>
                      </div>
                      <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                  </div>

                  <!-- Status Info -->
                  <div class="status-info">
                    <h3 id="status-title">Processing Document</h3>
                    <p id="status-message">Preparing your document for analysis...</p>
                    <div class="status-stages">
                      <div class="stage" id="stage-upload">
                        <div class="stage-icon"><i class="ri-upload-line"></i></div>
                        <span>Upload</span>
                      </div>
                      <div class="stage" id="stage-analyze">
                        <div class="stage-icon"><i class="ri-search-line"></i></div>
                        <span>Analyze</span>
                      </div>
                      <div class="stage" id="stage-generate">
                        <div class="stage-icon"><i class="ri-magic-line"></i></div>
                        <span>Generate</span>
                      </div>
                    </div>
                  </div>

                  <!-- Estimated Time -->
                  <div class="estimated-time">
                    <i class="ri-time-line"></i>
                    <span id="estimated-time">Estimating time...</span>
                  </div>

                  <!-- Cancel Button -->
                  <button class="cancel-processing-btn" id="cancel-processing" onclick="cancelProcessing()">
                    <i class="ri-close-line"></i>
                    Cancel Processing
                  </button>
                </div>
              </div>
            </div>

            <!-- Recent Jobs -->
            {% if recent_jobs %}
            <div class="recent-jobs">
              <h3>Recent Quizzes</h3>
              <div class="jobs-list">
                {% for job in recent_jobs %}
                <div class="job-item">
                  <div class="job-info" style="flex: 1 1 0; min-width: 0;">
                    <h4 class="job-filename" title="{{ job.document_name }}">{{ job.document_name }}</h4>
                    <p class="job-status status-{{ job.status }}">{{ job.get_status_display }}</p>
                    <small>{{ job.created_at|date:"M d, Y H:i" }}</small>
                  </div>
                  <div class="job-actions">
                    {% if job.status == 'completed' %}
                      <a href="{% url 'dashboard:start_exam' job.id %}" class="btn-small btn-primary">
                        <i class="ri-play-circle-line"></i>
                        Start Exam
                      </a>
                      <a href="{% url 'dashboard:start_flashcard' job.id %}" class="btn-small btn-secondary">
                        <i class="ri-stack-line"></i>
                        Start Flashcard
                      </a>
                      <button class="btn-small btn-danger" onclick="deleteQuiz({{ job.id }}, '{{ job.document_name|escapejs }}')">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    {% elif job.status == 'failed' %}
                      <span class="error-text">Failed</span>
                      <button class="btn-small btn-danger" onclick="deleteQuiz({{ job.id }}, '{{ job.document_name|escapejs }}')">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    {% else %}
                      <span class="processing-text">Processing...</span>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              <a href="{% url 'dashboard:my_quizzes' %}" class="view-all-link">View All Quizzes â†’</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
<!-- Dropzone JavaScript -->
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script src="{% static 'js/quiz_create.js' %}"></script>
{% endblock %}
