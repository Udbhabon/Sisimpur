{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Exam Results - {{ exam_session.processing_job.document_name }} - SISIMPUR{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/exam_result.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-container">
        <div class="results-container" {% if exam_session.percentage_score >= 90 %}data-celebrate="true"{% endif %}>
            <!-- Results Header -->
            <div class="results-header">
                <h1 class="results-title">Exam Completed!</h1>
                <p class="results-subtitle">{{ exam_session.processing_job.document_name }}</p>
                
                <!-- Score Display -->
                <div class="score-display">
                    <div class="score-circle">
                        <svg>
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="bg-circle" cx="75" cy="75" r="70" />
                            <circle class="progress-circle" cx="75" cy="75" r="70" style="stroke-dashoffset: calc(440 - (440 * {{ exam_session.percentage_score }}) / 100);" />
                        </svg>
                        <div class="score-text">
                            <div class="score-percentage">{{ exam_session.percentage_score|floatformat:0 }}%</div>
                            <div class="score-label">Score</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Badge -->
                {% if exam_session.percentage_score >= 90 %}
                    <div class="performance-badge badge-excellent">Excellent Performance! üéâ</div>
                {% elif exam_session.percentage_score >= 75 %}
                    <div class="performance-badge badge-good">Good Job! üëç</div>
                {% elif exam_session.percentage_score >= 60 %}
                    <div class="performance-badge badge-average">Average Performance üìö</div>
                {% else %}
                    <div class="performance-badge badge-poor">Keep Practicing! üí™</div>
                {% endif %}
            </div>

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card correct">
                    <div class="stat-value">{{ correct_answers }}</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card incorrect">
                    <div class="stat-value">{{ incorrect_answers }}</div>
                    <div class="stat-label">Incorrect Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ unanswered_questions }}</div>
                    <div class="stat-label">Unanswered</div>
                </div>
                <div class="stat-card time">
                    <div class="stat-value">{{ exam_session.get_time_elapsed_seconds|floatformat:0 }}s</div>
                    <div class="stat-label">Time Taken</div>
                </div>
                <div class="stat-card points">
                    <div class="stat-value">{{ exam_session.credit_points }}</div>
                    <div class="stat-label">Credit Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ exam_session.attempt_number }}</div>
                    <div class="stat-label">Attempt Number</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="{% url 'dashboard:start_exam' exam_session.processing_job.id %}" class="action-btn btn-retry">
                    <i class="ri-refresh-line"></i>
                    Retry Exam
                </a>

                <a href="{% url 'dashboard:my_quizzes' %}" class="action-btn btn-back">
                    <i class="ri-arrow-left-line"></i>
                    Back to Quizzes
                </a>
            </div>

            <!-- Answers Review -->
            <div class="answers-review">
                <h2 class="review-header">Answer Review</h2>
                
                {% if is_short_answer_exam %}
                    <!-- Short Answer Review -->
                    {% for evaluation in short_answer_evaluations %}
                        <div class="answer-item {% if evaluation.percentage_score >= 60 %}correct{% else %}incorrect{% endif %}">
                            <div class="answer-question">
                                <strong>Q{{ evaluation.question_index|add:1 }}:</strong> {{ evaluation.question.question }}
                            </div>
                            
                            <!-- Score Display -->
                            <div class="score-display-short">
                                <div class="score-circle-small">
                                    <span class="score-number">{{ evaluation.score }}/{{ evaluation.max_score }}</span>
                                    <span class="score-percentage">({{ evaluation.percentage_score|floatformat:1 }}%)</span>
                                </div>
                            </div>
                            
                            <div class="answer-details-short">
                                <div class="user-answer-short">
                                    <strong>Your Answer:</strong>
                                    <div class="answer-text">{{ evaluation.user_answer }}</div>
                                </div>
                                
                                <div class="evaluation-feedback">
                                    <strong>Feedback:</strong>
                                    <div class="feedback-text">{{ evaluation.feedback }}</div>
                                </div>
                                
                                <div class="ideal-answer">
                                    <strong>Ideal Answer:</strong>
                                    <div class="ideal-text">{{ evaluation.ideal_answer }}</div>
                                </div>
                                
                                <!-- Detailed Scores -->
                                <div class="detailed-scores">
                                    <h4>Detailed Scoring:</h4>
                                    <div class="score-breakdown">
                                        <div class="score-item">
                                            <span class="score-label">Accuracy:</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: {{ evaluation.accuracy_score|floatformat:0 }}0%"></div>
                                            </div>
                                            <span class="score-value">{{ evaluation.accuracy_score|floatformat:1 }}/10</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Completeness:</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: {{ evaluation.completeness_score|floatformat:0 }}0%"></div>
                                            </div>
                                            <span class="score-value">{{ evaluation.completeness_score|floatformat:1 }}/10</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Clarity:</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: {{ evaluation.clarity_score|floatformat:0 }}0%"></div>
                                            </div>
                                            <span class="score-value">{{ evaluation.clarity_score|floatformat:1 }}/10</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Structure:</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: {{ evaluation.structure_score|floatformat:0 }}0%"></div>
                                            </div>
                                            <span class="score-value">{{ evaluation.structure_score|floatformat:1 }}/10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- Evaluation Summary -->
                    {% if evaluation_summary %}
                    <div class="evaluation-summary">
                        <h3>Performance Analysis</h3>
                        <div class="summary-stats">
                            <div class="summary-item">
                                <span class="summary-label">Total Score:</span>
                                <span class="summary-value">{{ evaluation_summary.total_score }}/{{ evaluation_summary.max_score }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Average Score:</span>
                                <span class="summary-value">{{ evaluation_summary.average_score|floatformat:1 }}%</span>
                            </div>
                        </div>
                        
                        <div class="strengths-weaknesses">
                            <div class="strengths">
                                <h4>Strengths:</h4>
                                <ul>
                                    {% for strength in evaluation_summary.strengths %}
                                        <li>{{ strength }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            <div class="weaknesses">
                                <h4>Areas for Improvement:</h4>
                                <ul>
                                    {% for weakness in evaluation_summary.weaknesses %}
                                        <li>{{ weakness }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="suggestions">
                            <h4>Suggestions:</h4>
                            <ul>
                                {% for suggestion in evaluation_summary.suggestions %}
                                    <li>{{ suggestion }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <!-- Multiple Choice Review -->
                    {% for answer in answers %}
                        <div class="answer-item {% if answer.is_correct %}correct{% else %}incorrect{% endif %}">
                            <div class="answer-question">
                                <strong>Q{{ answer.question_index|add:1 }}:</strong> {{ answer.question.question }}
                            </div>
                            <div class="answer-details">
                                <div class="user-answer {% if answer.is_correct %}correct{% endif %}">
                                    <strong>Your Answer:</strong>
                                    {% if answer.question.question_type == 'MULTIPLECHOICE' and answer.user_answer %}
                                        {% for option in answer.question.get_formatted_options %}
                                            {% if option.key == answer.user_answer %}
                                                {{ option.key }}) {{ option.text }}
                                            {% endif %}
                                        {% endfor %}
                                        {% if not answer.user_answer %}Not answered{% endif %}
                                    {% else %}
                                        {{ answer.user_answer|default:"Not answered" }}
                                    {% endif %}
                                </div>
                                <div class="correct-answer">
                                    <strong>Correct Answer:</strong>
                                    {% if answer.question.question_type == 'MULTIPLECHOICE' %}
                                        {{ answer.question.get_correct_display }}
                                    {% else %}
                                        {{ answer.question.answer }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/exam_result.js' %}"></script>
{% endblock %}
