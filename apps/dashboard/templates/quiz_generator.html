{% extends 'dashboard_base.html' %} 
{% load static %}
{% block title %} Quiz Generator - SISIMPUR {% endblock %}
{% block content %}

<div class="content-wrapper">
  <div class="content-container">
    <div class="quiz-section">
      <h1 class="page-title">Document Quiz Generator</h1>
      <p class="page-description">Upload documents and generate AI-powered quizzes with OCR text extraction</p>

      <div class="quiz-form">
        <form id="document-upload-form" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group">
            <label>Upload Document</label>
            <p class="upload-description">Our AI will extract text using OCR and generate questions automatically</p>

            <div class="file-upload">
              <input type="file" id="file-input" name="document" accept=".pdf,.jpg,.jpeg,.png" required hidden />
              <label for="file-input" class="file-upload-btn">
                <i class="ri-upload-cloud-line"></i>
                Upload Document
              </label>
              <span class="file-types">Supported: PDF, JPG, PNG</span>
              <div id="file-preview" class="file-preview" style="display: none;"></div>
            </div>
          </div>

          <div class="quiz-options">
            <div class="option-group">
              <label>Number of Questions</label>
              <select class="quiz-select" id="question-count" name="num_questions">
                <option value="">Auto (Optimal)</option>
                <option value="3">3 Questions</option>
                <option value="5">5 Questions</option>
                <option value="8">8 Questions</option>
                <option value="10" selected>10 Questions</option>
                <option value="15">15 Questions</option>
                <option value="20">20 Questions</option>
              </select>
            </div>

            <div class="option-group">
              <label>Question Type</label>
              <select class="quiz-select" id="question-type" name="question_type">
                <option value="MULTIPLECHOICE" selected>Multiple Choice</option>
                <option value="SHORT">Short Answer</option>
              </select>
            </div>

            <div class="option-group">
              <label>Language Detection</label>
              <select class="quiz-select" id="language" name="language">
                <option value="auto" selected>Auto Detect</option>
                <option value="english">English</option>
                <option value="bengali">Bengali</option>
              </select>
            </div>
          </div>

          <button type="submit" class="generate-btn" id="generate-btn">
            <i class="ri-magic-line"></i>
            <span id="btn-text">Generate Quiz</span>
            <div id="loading-spinner" style="display: none;">
              <i class="ri-loader-4-line"></i> Processing...
            </div>
          </button>
        </form>

        <!-- Processing Status -->
        <div id="processing-status" style="display: none;" class="processing-status">
          <div class="status-content">
            <div class="status-icon">
              <i class="ri-loader-4-line"></i>
            </div>
            <h3>Processing Document...</h3>
            <p id="status-message">Extracting text and generating questions...</p>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('document-upload-form');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const generateBtn = document.getElementById('generate-btn');
    const btnText = document.getElementById('btn-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const processingStatus = document.getElementById('processing-status');
    const statusMessage = document.getElementById('status-message');
    const progressFill = document.getElementById('progress-fill');

    // File preview
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            filePreview.style.display = 'block';
            filePreview.innerHTML = `
                <div class="file-info">
                    <i class="ri-file-line"></i>
                    <span>${file.name}</span>
                    <small>(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                </div>
            `;
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        // Show loading state
        btnText.style.display = 'none';
        loadingSpinner.style.display = 'inline-block';
        generateBtn.disabled = true;
        
        // Submit to API
        fetch('{% url "dashboard:api_process_document" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show processing status
                form.style.display = 'none';
                processingStatus.style.display = 'block';
                
                // Poll for job status
                pollJobStatus(data.job_id);
            } else {
                alert('Error: ' + data.error);
                resetForm();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the document.');
            resetForm();
        });
    });

    function pollJobStatus(jobId) {
        const pollInterval = setInterval(() => {
            fetch(`{% url "dashboard:api_job_status" 0 %}`.replace('0', jobId))
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    window.location.href = `{% url "dashboard:quiz_results" 0 %}`.replace('0', jobId);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    alert('Processing failed: ' + (data.error_message || 'Unknown error'));
                    resetForm();
                } else {
                    // Update progress
                    statusMessage.textContent = 'Processing... (' + data.status + ')';
                    const progress = data.status === 'processing' ? 50 : 25;
                    progressFill.style.width = progress + '%';
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
            });
        }, 2000); // Poll every 2 seconds
    }

    function resetForm() {
        btnText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
        generateBtn.disabled = false;
        processingStatus.style.display = 'none';
        form.style.display = 'block';
    }
});
</script>

{% endblock %}
